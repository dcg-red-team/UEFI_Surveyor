# UEFI Surveyor: A collection of GHIDRA scripts and tools to improve UEFI Binary Analysis and automation
---
## Introduction
---
This repository contains a series of python scripts that will run with GHIDRA and several other UEFI tools to automate labeling and make identification of potential issues easier.
The current state allows the tool to label each UEFI file with proper entry points, guids, and protocols.  For SMM modules, the tool will search for classes of issues such as a path to callouts or when the commbuffer has been dereferenced multiple times.

## Setup
---
### Pre-requisites
UEFISurveyor will need a gdt file, guid database, and collection of efi binaries extracted from a spi dump or UEFI/bios update.  UEFISurveyor will need a copy of working GHIDRA already setup on the system.

  - GHIDRA – Recommend version 10.3.1 Public or later
  - Python – Should work with python 3.6 or later (tested with 3.8 and 3.10)
  - Python Packages – PyYaml
  - UEFI source Code – Should be downloaded onto the system (at minimal use github.com/tianocore/edk2)
  - GDT file (see Tools/pfrGenerator/README.md) – File containing UEFI structures that is generated by parsing the UEFI header files.
  - GUID Database (see Tools/guidFinder/README.md) – File containing a list of known GUIDs, protocols, and PPIs
  - UEFITool – (see Tools/decompressionHelper) Used for decompressing the bios image (github.com/longsoft/uefitool)
  - CHIPSEC - (see Tools/decompressionHelper) Used for decompressing the bios image (github.com/chipsec/chipsec)

## Running
Once the prerequisites are satisified:
---
### In GHIDRA HEADLESS mode
Edit the Options.yaml file
```

Analysis:
  Ghidrapath: 'Path to Ghidra'
  Projectpath: 'Path to store the project'
  Projectname: 'Name of the project within Ghidra'
  Scriptpath: 'Path to UEFISurveyor'
  EFIPath: 'Path where extracted binaries are located'
  GUIDDB: 'Path to guid_db file'
  GDT: 'Path to gdt file'

```
To run the tool within headless mode:
`python headless_runner.py`

### Within a GHIDRA GUI
Open gui_runner.py
  Change the paths for guidFile and gdtPath to where they exist on the system
Copy the python files under UEFISurveyor into Ghidra (GHIDRA_PATH/Ghidra/Features/Python/ghidra_scripts).  Note analyze_post and analyze_pre are not necessary for running in GUI mode.
Open the Script Manager (Window->Script Manager). Navigate to the UEFISurveyor folder.  Run the gui_runner.py script.

## Output
---
### Headless Mode
Headless mode will then create a log file for each efi file located within the directory for efi file.  A log file containing:
  - Identified Guids
  - Identified Protocols/PPIs
  - Labels Applied
  - Functions Updated (parameters, names)
  - Registered Notify Events
  - Potential Callouts
  - Times Commbuffer is dereferenced
  - Instances of (G/S)ET_VARIABLE

A json file with the functions and function hashes is also created.

## Known limitations
---
  - The tool needs logic modification to only run analyitics on compatable files.


## Overview of Operations
---
  - Extract the binary file
  - Create folder and copy efi specific files into the folder
  - For each efi file within the folder
    -  Load the gdt file and parse the guids file
    -  Search the binary and label matching guids
    -  Label the ModuleEntryPoint (based upon entry point calculation within PE/TE header)
    -  Propogate ModuleEntryPoint variables
    -  Identify system tables (gBS, gRt, etc)
    -  Identify gBS protocols
    -  Identify gSMST instances
    -  Identify Handlers
    -  Check for call paths between Handlers and gBS/gRT entries
    -  Check for Commbuffer Dereferences
    -  Check for (G/S)ET Variable calls
    -  Gather Function and Functin Hashes
    -  Create log

## Next Steps / Future Improvements
---
  Planned
  - Support for mulitple guids with the same name
  - Improved issue reporting (creating a combined report with areas of concern)
  - Improved Issue Triage (add cases to make issue reporting smarter)
  - Ability to report problems with analysis (if file was not analyzed or a guid for handler exists but handler was not found)
  - Identify when return value is not appropriately checked

  Experimental
  - Problems with Allocate/Free memory functions
  - Add dynamic analysis capabilities to handlers
  - Find uninitialized Stack variables
  - Find instances of stack not being zeroed


## Credits/References
---
  - [ghidra-firmware-utils](https://github.com/al3xtjames/ghidra-firmware-utils)
  - [efiSeek](https://github.com/DSecurity/efiSeek)
  - [Add support for UEFI datatype libraries](https://github.com/NationalSecurityAgency/ghidra/pull/501#issuecomment-498374810)
  - [GhidraSnippets](https://github.com/HackOvert/GhidraSnippets)

### Changes
  - Converted to Python (no longer a need to recompile for each new version of GHIDRA)
  - Improved support for local variables
  - Automated creation of GUID and pfr file


